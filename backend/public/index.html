<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Avezzano Plus</title>
  <style>
    body { margin:0; font-family:sans-serif; display:flex; height:100vh; overflow:hidden; }
    #sidebar { width:220px; background:#1e3a8a; color:white; display:flex; flex-direction:column; }
    #chatList { flex:1; overflow-y:auto; }
    .chatItem { padding:10px; cursor:pointer; border-bottom:1px solid #334; }
    .chatItem:hover { background:#3b5998; }
    #main { flex:1; display:flex; flex-direction:column; }
    #messages { flex:1; padding:10px; overflow-y:auto; background:#f0f4ff; }
    .msg { margin:5px 0; display:flex; align-items:center; }
    .msg img { width:32px; height:32px; border-radius:50%; margin-right:8px; }
    #inputBar { display:flex; }
    #inputBar input { flex:1; padding:10px; border:none; }
    #inputBar button { padding:10px; background:#1e3a8a; color:white; border:none; }
    #overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:white; display:flex; justify-content:center; align-items:center; }
    #register { background:#f0f4ff; padding:20px; border-radius:12px; text-align:center; }
    #profilePics img { width:50px; height:50px; border-radius:50%; margin:5px; cursor:pointer; border:2px solid transparent; }
    #profilePics img.selected { border-color:#1e3a8a; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3 style="text-align:center;">Chat</h3>
    <div id="chatList"></div>
  </div>
  <div id="main">
    <div id="messages"></div>
    <div id="inputBar">
      <input id="msgInput" placeholder="Scrivi un messaggio..." />
      <button id="sendBtn">Invia</button>
    </div>
  </div>

  <div id="overlay">
    <div id="register">
      <h2>Registrati</h2>
      <input id="nameInput" placeholder="Il tuo nome"><br><br>
      <div id="profilePics">
        <img src="https://i.pravatar.cc/100?img=1">
        <img src="https://i.pravatar.cc/100?img=2">
        <img src="https://i.pravatar.cc/100?img=3">
      </div>
      <br>
      <button id="joinBtn">Entra</button>
    </div>
  </div>

  <script>
    const ws = new WebSocket(location.origin.replace(/^http/, 'ws'));
    let userData = null;
    let chats = { "Pubblica": [] };
    let activeChat = "Pubblica";

    const chatList = document.getElementById("chatList");
    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");

    function renderChatList() {
      chatList.innerHTML = "";
      for (const key in chats) {
        const div = document.createElement("div");
        div.className = "chatItem";
        div.textContent = key;
        if (key === activeChat) div.style.background="#3b82f6";
        div.onclick = () => { activeChat = key; renderChat(); renderChatList(); };
        chatList.appendChild(div);
      }
    }

    function renderChat() {
      messagesDiv.innerHTML = "";
      for (const m of chats[activeChat]) {
        const div = document.createElement("div");
        div.className = "msg";
        div.innerHTML = `<img src="${m.profilePic}"><b>${m.user}:</b> ${m.message}`;
        messagesDiv.appendChild(div);
      }
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function ensureChatInList(name) {
      if (!chats[name]) chats[name] = [];
      renderChatList();
    }

    sendBtn.onclick = () => {
      const txt = msgInput.value.trim();
      if (!txt) return;
      if (activeChat === "Pubblica") {
        ws.send(JSON.stringify({ type:"chat", message:txt }));
      } else {
        ws.send(JSON.stringify({ type:"private", to:activeChat, message:txt }));
      }
      msgInput.value="";
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === "chat") {
        chats["Pubblica"].push({ user:data.user, profilePic:data.profilePic, message:data.message });
        if (activeChat==="Pubblica") renderChat();
      }

      else if (data.type === "private") {
        const sender = data.from;
        const chatKey = (sender === userData.name) ? data.to : sender;
        const displayName = (sender === userData.name) ? "Me" : sender;

        if (!chats[chatKey]) chats[chatKey] = [];
        chats[chatKey].push({ user:displayName, profilePic:data.profilePic, message:data.message });
        if (activeChat === chatKey) renderChat();
        ensureChatInList(chatKey);
      }

      else if (data.type === "online") {
        console.log("Utenti online:", data.users);
      }
    };

    // Registrazione
    let selectedPic="";
    document.querySelectorAll("#profilePics img").forEach(img=>{
      img.onclick=()=>{
        document.querySelectorAll("#profilePics img").forEach(i=>i.classList.remove("selected"));
        img.classList.add("selected");
        selectedPic = img.src;
      };
    });

    document.getElementById("joinBtn").onclick = () => {
      const name=document.getElementById("nameInput").value.trim();
      if (!name || !selectedPic) return alert("Inserisci nome e seleziona immagine");
      userData={ name, profilePic:selectedPic };
      ws.send(JSON.stringify({ type:"register", ...userData }));
      document.getElementById("overlay").style.display="none";
      renderChatList();
      renderChat();
    };
  </script>
</body>
</html>

