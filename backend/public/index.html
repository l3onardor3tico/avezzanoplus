<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Avezzano Plus</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: #f9f9f9;
      overflow-x: hidden;
    }
    header {
      background:#007bff;
      color:#fff;
      padding:1rem;
      text-align:center;
      flex-shrink: 0;
    }
    #app {
      display: flex;
      height: calc(100% - 64px);
      overflow: hidden;
    }
    #sidebar {
      background:#fff;
      border-right:1px solid #ccc;
      width: 220px;
      flex-shrink: 0;
      overflow-y:auto;
    }
    #sidebar h3 {
      margin:0;
      padding:0.75rem;
      background:#eef5ff;
      border-bottom:1px solid #ccc;
    }
    #chat-list {
      list-style:none;
      margin:0;
      padding:0;
    }
    #chat-list li {
      padding:0.75rem;
      border-bottom:1px solid #eee;
      cursor:pointer;
    }
    #chat-list li.active {
      background:#dbe8ff;
      font-weight:bold;
    }
    #main {
      flex:1;
      display:flex;
      flex-direction:column;
      min-width: 0;
    }
    #chat-window {
      flex:1;
      overflow-y:auto;
      padding:1rem;
      background:#fff;
    }
    .msg {
      display:flex;
      align-items:center;
      margin-bottom:6px;
      word-wrap:break-word;
    }
    .msg img {
      width:32px; height:32px;
      border-radius:50%;
      margin-right:8px;
      object-fit:cover;
    }
    #input-bar {
      display:flex;
      border-top:1px solid #ccc;
      background:#f1f1f1;
      padding:0.5rem;
    }
    #input-bar input {
      flex:1;
      padding:0.5rem;
      border:1px solid #ccc;
      border-radius:4px;
      font-size:1rem;
    }
    #input-bar button {
      margin-left:0.5rem;
      padding:0.5rem 1rem;
      border:none;
      background:#007bff;
      color:#fff;
      border-radius:4px;
      font-size:1rem;
    }
    #online-list {
      border-top:1px solid #ccc;
      max-height:150px;
      overflow-y:auto;
      background:#fafafa;
    }
    .user {
      display:flex;
      align-items:center;
      padding:0.5rem;
      border-bottom:1px solid #eee;
      cursor:pointer;
    }
    .user img {
      width:28px; height:28px;
      border-radius:50%;
      margin-right:8px;
      object-fit:cover;
    }
    @media (max-width:768px) {
      #sidebar {
        position:absolute;
        left:-240px;
        top:64px;
        bottom:0;
        width:220px;
        transition:left 0.3s;
        z-index:1000;
      }
      #sidebar.show {
        left:0;
      }
      #toggle-sidebar {
        position:absolute;
        left:10px;
        top:10px;
        background:#fff;
        border:1px solid #ccc;
        padding:0.25rem 0.5rem;
        cursor:pointer;
        border-radius:4px;
      }
    }
  </style>
</head>
<body>
  <header>
    Avezzano Plus
    <button id="toggle-sidebar" style="display:none;">â˜°</button>
  </header>

  <div id="app">
    <div id="sidebar">
      <h3>Chat</h3>
      <ul id="chat-list">
        <li class="active" data-chat="public">Chat Pubblica</li>
      </ul>
      <h3>Utenti online</h3>
      <div id="online-list"></div>
    </div>

    <div id="main">
      <div id="chat-window"></div>
      <div id="input-bar">
        <input id="msg" placeholder="Scrivi un messaggio..." maxlength="240">
        <button id="sendBtn">Invia</button>
      </div>
    </div>
  </div>

<script>
/* COSTANTI GEO */
const AVEZZANO_LAT = 42.0214, AVEZZANO_LON = 13.4256, MAX_DISTANCE_KM = 15;
function haversine(lat1, lon1, lat2, lon2) {
  function toRad(x){return x*Math.PI/180;}
  const R=6371, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* VARIABILI */
let socket;
let userData = JSON.parse(localStorage.getItem('userData') || 'null');
let activeChat = "public";
let chats = { public: [] };

/* UI */
const chatWindow = document.getElementById('chat-window');
const sendBtn = document.getElementById('sendBtn');
const msgInput = document.getElementById('msg');
const chatList = document.getElementById('chat-list');
const onlineList = document.getElementById('online-list');
const sidebar = document.getElementById('sidebar');
const toggleSidebarBtn = document.getElementById('toggle-sidebar');

/* Mostra messaggi */
function renderChat() {
  chatWindow.innerHTML = "";
  (chats[activeChat] || []).forEach(m => {
    const div = document.createElement('div');
    div.className = 'msg';
    const img = document.createElement('img');
    img.src = m.profilePic || '';
    const span = document.createElement('span');
    span.textContent = m.user + ": " + m.message;
    div.appendChild(img);
    div.appendChild(span);
    chatWindow.appendChild(div);
  });
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

/* Invia messaggi */
function sendMessage() {
  const text = msgInput.value.trim();
  if (!text || !socket || socket.readyState !== WebSocket.OPEN) return;
  if (activeChat === "public") {
    socket.send(JSON.stringify({ type: "chat", message: text }));
  } else {
    socket.send(JSON.stringify({ type: "private", to: activeChat, message: text }));
    chats[activeChat].push({ user: "Me", profilePic: userData.profilePic, message: text });
    renderChat();
  }
  msgInput.value = "";
}
sendBtn.addEventListener('click', sendMessage);
msgInput.addEventListener('keydown', e => { if (e.key === "Enter") sendMessage(); });

/* Connessione socket */
function startChat() {
  socket = new WebSocket('wss://' + window.location.host);

  socket.addEventListener('open', () => {
    socket.send(JSON.stringify({ type: 'join', name: userData.name, profilePic: userData.profilePic }));
  });

  socket.addEventListener('message', ev => {
    let data;
    try { data = JSON.parse(ev.data); } catch(e){ return; }

    if (data.type === "chat") {
      chats.public.push({ user: data.user, profilePic: data.profilePic, message: data.message });
      if (activeChat === "public") renderChat();
    } else if (data.type === "online") {
      onlineList.innerHTML = "";
      (data.users || []).forEach(u => {
        const row = document.createElement('div');
        row.className = "user";
        row.innerHTML = `<img src="${u.profilePic}"><span>${u.name}</span>`;
        row.onclick = () => openPrivateChat(u.name, u.profilePic);
        onlineList.appendChild(row);
      });
    } else if (data.type === "private") {
      if (!chats[data.from]) chats[data.from] = [];
      chats[data.from].push({ user: data.from, profilePic: data.profilePic, message: data.message });
      if (activeChat === data.from) renderChat();
      ensureChatInList(data.from);
    }
  });
}

/* Apri chat privata */
function openPrivateChat(name, pic) {
  activeChat = name;
  if (!chats[name]) chats[name] = [];
  ensureChatInList(name);
  setActiveChat(name);
}

/* Lista chat */
function ensureChatInList(name) {
  if (!chatList.querySelector(`[data-chat="${name}"]`)) {
    const li = document.createElement('li');
    li.textContent = name;
    li.dataset.chat = name;
    li.onclick = () => setActiveChat(name);
    chatList.appendChild(li);
  }
}
function setActiveChat(name) {
  activeChat = name;
  [...chatList.children].forEach(li => li.classList.toggle("active", li.dataset.chat === name));
  renderChat();
}

/* Sidebar mobile */
if (window.innerWidth <= 768) {
  toggleSidebarBtn.style.display = "inline-block";
  toggleSidebarBtn.addEventListener('click', () => {
    sidebar.classList.toggle("show");
  });
}

/* GEO + START */
if (userData) {
  navigator.geolocation.getCurrentPosition((pos)=>{
    const d=haversine(pos.coords.latitude,pos.coords.longitude,AVEZZANO_LAT,AVEZZANO_LON);
    if(d<=MAX_DISTANCE_KM){ startChat(); renderChat(); }
    else { alert("Accesso solo da Avezzano. Sei a " + d.toFixed(1) + " km."); localStorage.removeItem('userData'); }
  },(err)=>{
    alert("Geolocalizzazione non disponibile: devi registrarti di nuovo.");
    localStorage.removeItem('userData');
  },{timeout:10000});
} else {
  alert("Prima completa la registrazione!");
}
</script>
</body>
</html>
