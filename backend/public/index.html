<script>
let socket;
let userData = JSON.parse(localStorage.getItem('userData') || 'null');
let activeChat = "public";
let chats = { public: [] };
let socketReady = false;

const chatWindow = document.getElementById('chat-window');
const sendBtn = document.getElementById('sendBtn');
const msgInput = document.getElementById('msg');
const chatList = document.getElementById('chat-list');
const onlineList = document.getElementById('online-list');
const sidebar = document.getElementById('sidebar');
const toggleSidebarBtn = document.getElementById('toggle-sidebar');

function renderChat() {
  chatWindow.innerHTML = "";
  (chats[activeChat] || []).forEach(m => {
    const div = document.createElement('div');
    div.className = 'msg';
    const img = document.createElement('img');
    img.src = m.profilePic || '';
    const span = document.createElement('span');
    span.textContent = m.user ? `${m.user}: ${m.message}` : m.message;
    div.appendChild(img);
    div.appendChild(span);
    chatWindow.appendChild(div);
  });
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function sendMessage() {
  const text = msgInput.value.trim();
  if (!text || !socketReady) return;

  if (activeChat === "public") {
    socket.send(JSON.stringify({ type: "chat", message: text }));
  } else {
    socket.send(JSON.stringify({ type: "private", to: activeChat, message: text }));
    if (!chats[activeChat]) chats[activeChat] = [];
    chats[activeChat].push({ user: userData.name, profilePic: userData.profilePic, message: text });
    renderChat();
  }
  msgInput.value = "";
}
sendBtn.addEventListener('click', sendMessage);
msgInput.addEventListener('keydown', e => { if (e.key === "Enter") sendMessage(); });

function startChat() {
  socket = new WebSocket('wss://' + window.location.host);

  socket.addEventListener('open', () => {
    socketReady = true;
    socket.send(JSON.stringify({ type: 'join', name: userData.name, profilePic: userData.profilePic }));
  });

  socket.addEventListener('close', () => socketReady = false);

  socket.addEventListener('message', ev => {
    let data;
    try { data = JSON.parse(ev.data); } catch(e){ return; }

    if (data.type === "chat") {
      chats.public.push({ user: data.user, profilePic: data.profilePic, message: data.message });
      if (activeChat === "public") renderChat();

    } else if (data.type === "chatHistory") {
      chats[data.chat] = (data.messages || []).map(m => ({
        user: m.user || m.from,
        profilePic: m.profilePic,
        message: m.message
      }));
      if (activeChat === data.chat) renderChat();

    } else if (data.type === "online") {
      onlineList.innerHTML = "";
      (data.users || []).forEach(u => {
        if (u.name === userData.name) return;
        const row = document.createElement('div');
        row.className = "user";
        row.innerHTML = `<img src="${u.profilePic}"><span>${u.name}</span>`;
        row.onclick = () => openPrivateChat(u.name, u.profilePic);
        onlineList.appendChild(row);
      });

    } else if (data.type === "private") {
      if (data.from === userData.name) return;
      if (!chats[data.from]) chats[data.from] = [];
      chats[data.from].push({ user: data.from, profilePic: data.profilePic, message: data.message });
      ensureChatInList(data.from);
      if (activeChat === data.from) renderChat();
    }
  });
}

function openPrivateChat(name, pic) {
  if (name === userData.name) return;
  ensureChatInList(name);
  setActiveChat(name);

  if (!chats[name]) chats[name] = [];
  renderChat();

  // ✅ attende che il socket sia pronto prima di inviare la richiesta
  const tryLoad = () => {
    if (socketReady && socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({ type: "loadPrivateChat", with: name }));
    } else {
      setTimeout(tryLoad, 200); // ritenta finché non è pronto
    }
  };
  tryLoad();
}

function ensureChatInList(name) {
  if (!chatList.querySelector(`[data-chat="${name}"]`)) {
    const li = document.createElement('li');
    li.textContent = name;
    li.dataset.chat = name;
    li.onclick = () => setActiveChat(name);
    chatList.appendChild(li);
  }
}

function setActiveChat(name) {
  activeChat = name;
  [...chatList.children].forEach(li => li.classList.toggle("active", li.dataset.chat === name));
  renderChat();
}

chatList.querySelector('[data-chat="public"]').onclick = () => setActiveChat("public");

if (window.innerWidth <= 768) {
  toggleSidebarBtn.style.display = "inline-block";
  toggleSidebarBtn.addEventListener('click', () => {
    sidebar.classList.toggle("show");
  });
}

if (userData) startChat();
else alert("Prima completa la registrazione!");
</script>
