<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Avezzano Plus</title>
  <style>
    html,body{height:100%;margin:0;padding:0;font-family:sans-serif;background:#f9f9f9;overflow-x:hidden;}
    header{background:#007bff;color:#fff;padding:1rem;text-align:center;position:relative;}
    #app{display:flex;height:calc(100% - 64px);overflow:hidden;}
    #sidebar{background:#fff;border-right:1px solid #ccc;width:240px;flex-shrink:0;overflow-y:auto;}
    #profile-section{text-align:center;padding:1rem;border-bottom:1px solid #ccc;}
    #profile-section img{width:64px;height:64px;border-radius:50%;object-fit:cover;cursor:pointer;}
    #chat-list{list-style:none;margin:0;padding:0;}
    #chat-list li{padding:0.75rem;border-bottom:1px solid #eee;cursor:pointer;}
    #chat-list li.active{background:#dbe8ff;font-weight:bold;}
    #main{flex:1;display:flex;flex-direction:column;min-width:0;}
    #chat-window{flex:1;overflow-y:auto;padding:1rem;background:#fff;}
    .msg{display:flex;align-items:center;margin-bottom:8px;}
    .msg img{width:36px;height:36px;border-radius:50%;margin-right:8px;object-fit:cover;}
    .bubble{background:#f4f6fb;padding:8px 10px;border-radius:8px;max-width:75%;word-wrap:break-word;}
    .me .bubble{background:#dbe8ff;}
    #input-bar{display:flex;border-top:1px solid #ccc;background:#f1f1f1;padding:0.5rem;}
    #input-bar input{flex:1;padding:0.5rem;border:1px solid #ccc;border-radius:4px;}
    #input-bar button{margin-left:0.5rem;padding:0.5rem 1rem;border:none;background:#007bff;color:#fff;border-radius:4px;cursor:pointer;}
    #online-list{border-top:1px solid #ccc;max-height:180px;overflow:auto;background:#fafafa;}
    .user{display:flex;align-items:center;padding:0.5rem;border-bottom:1px solid #eee;cursor:pointer;}
    .user img{width:32px;height:32px;border-radius:50%;margin-right:8px;object-fit:cover;}
    #status{position:absolute;right:12px;top:12px;color:#fff;font-size:0.85rem;}
    @media (max-width:768px){ #sidebar{position:absolute;left:-260px;top:64px;bottom:0;width:240px;transition:left 0.25s;z-index:1000;} #sidebar.show{left:0;} #toggle-sidebar{position:absolute;left:10px;top:10px;background:#fff;border:1px solid #ccc;padding:0.25rem 0.5rem;border-radius:4px;} }
  </style>
</head>
<body>
  <header>Avezzano Plus<div id="status">Connessione: <span id="conn-state">—</span></div></header>
  <div id="app">
    <aside id="sidebar">
      <div id="profile-section">
        <img id="profile-pic" src="" alt="Foto" title="Clicca per cambiare foto">
        <div id="username" style="margin-top:6px;font-weight:600"></div>
        <input id="picInput" type="file" accept="image/*" style="display:none">
      </div>
      <h3 style="margin:0;padding:0.5rem;background:#eef5ff;border-bottom:1px solid #ccc;">Le tue chat</h3>
      <ul id="chat-list"><li class="active" data-chat="public">Chat Pubblica</li></ul>
      <h3 style="margin:0;padding:0.5rem;background:#eef5ff;border-top:1px solid #ccc;border-bottom:1px solid #ccc;">Utenti online</h3>
      <div id="online-list"></div>
    </aside>

    <main id="main">
      <div id="chat-window" aria-live="polite"></div>
      <div id="input-bar">
        <input id="msg" placeholder="Scrivi un messaggio..." maxlength="240" autocomplete="off">
        <button id="sendBtn">Invia</button>
      </div>
    </main>
  </div>

<script>
/* client.js inline - robusto */
const connState = document.getElementById('conn-state');
const chatWindow = document.getElementById('chat-window');
const sendBtn = document.getElementById('sendBtn');
const msgInput = document.getElementById('msg');
const chatList = document.getElementById('chat-list');
const onlineList = document.getElementById('online-list');
const profilePicEl = document.getElementById('profile-pic');
const picInput = document.getElementById('picInput');
const usernameEl = document.getElementById('username');

let socket = null;
let socketReady = false;
let pending = [];
let userData = JSON.parse(localStorage.getItem('userData')||'null');
let openedChats = JSON.parse(localStorage.getItem('openedChats')||'[]');
let chats = {}; // chats.public, chats['Mario Rossi']
chats.public = chats.public || [];
let activeChat = 'public';
const seenMessageIds = new Set(); // per evitare duplicati

function setStatus(s){ connState.textContent = s; }

function renderChat(){
  chatWindow.innerHTML = '';
  const list = chats[activeChat] || [];
  for (const m of list){
    if (!m) continue;
    const div = document.createElement('div');
    div.className = 'msg' + ((m.user === userData.name)?' me':'');
    const img = document.createElement('img'); img.src = m.profilePic||'';
    const bubble = document.createElement('div'); bubble.className='bubble';
    bubble.textContent = (m.user? m.user + ': ' : '') + m.message;
    div.append(img,bubble);
    chatWindow.appendChild(div);
  }
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function ensureChatInList(name){
  if (chatList.querySelector(`[data-chat="${CSS.escape(name)}"]`)) return;
  const li = document.createElement('li');
  li.textContent = name;
  li.dataset.chat = name;
  li.addEventListener('click', ()=> setActiveChat(name));
  chatList.appendChild(li);
}

function setActiveChat(name){
  activeChat = name;
  [...chatList.children].forEach(li => li.classList.toggle('active', li.dataset.chat === name));
  renderChat();
  // persist openedChats for private chats
  if (name !== 'public' && !openedChats.includes(name)){
    openedChats.push(name);
    localStorage.setItem('openedChats', JSON.stringify(openedChats));
  }
}

function queueOrSend(obj){
  if (socketReady && socket && socket.readyState === WebSocket.OPEN) socket.send(JSON.stringify(obj));
  else pending.push(obj);
}
function flushPending(){
  while(pending.length && socket && socket.readyState === WebSocket.OPEN) socket.send(JSON.stringify(pending.shift()));
}

function sendMessage(){
  const text = (msgInput.value||'').trim();
  if (!text) return;
  if (!userData) { alert('Devi registrarti'); return; }
  if (activeChat === 'public'){
    const id = `m_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
    const local = { id, user: userData.name, profilePic: userData.profilePic||'', message:text, timestamp:Date.now() };
    chats.public = chats.public || []; chats.public.push(local);
    seenMessageIds.add(id);
    renderChat();
    queueOrSend({ type:'chat', id, message:text });
  } else {
    const id = `p_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
    const local = { id, user: userData.name, profilePic:userData.profilePic||'', message:text, timestamp:Date.now() };
    chats[activeChat] = chats[activeChat]||[]; chats[activeChat].push(local);
    seenMessageIds.add(id);
    renderChat();
    queueOrSend({ type:'private', id, to: activeChat, message:text });
    if (!openedChats.includes(activeChat)){ openedChats.push(activeChat); localStorage.setItem('openedChats', JSON.stringify(openedChats)); ensureChatInList(activeChat); }
  }
  msgInput.value = '';
}

function openPrivateChat(name){
  if (!userData) { alert('Devi registrarti'); return; }
  if (name === userData.name) return;
  ensureChatInList(name);
  setActiveChat(name);
  chats[name] = chats[name] || [];
  // richiedo cronologia (server risponde anche se offline)
  queueOrSend({ type:'loadPrivateChat', with: name });
}

function startSocket(){
  const proto = location.protocol === 'https:' ? 'wss://' : 'ws://';
  socket = new WebSocket(proto + location.host);
  setStatus('connessione...');
  socketReady = false;

  socket.addEventListener('open', ()=> {
    socketReady = true; setStatus('connesso');
    socket.send(JSON.stringify({ type:'join', name:userData.name, profilePic:userData.profilePic||'' }));
    flushPending();
    // richiedo cronologie di chat aperte
    for (const n of openedChats) { ensureChatInList(n); queueOrSend({ type:'loadPrivateChat', with:n }); }
  });

  socket.addEventListener('close', ()=> { socketReady=false; setStatus('disconnesso'); setTimeout(startSocket,1500); });
  socket.addEventListener('error', ()=> { setStatus('errore'); });

  socket.addEventListener('message', ev => {
    let data; try{ data = JSON.parse(ev.data); } catch(e){ return; }

    if (data.type === 'chat'){
      // dedup via id
      if (data.id && seenMessageIds.has(data.id)) return;
      if (data.id) seenMessageIds.add(data.id);
      chats.public = chats.public || [];
      chats.public.push({ id:data.id, user:data.user, profilePic:data.profilePic, message:data.message, timestamp:data.timestamp });
      if (activeChat === 'public') renderChat();
    }

    else if (data.type === 'chatHistory'){
      const chatId = data.chat === 'public' ? 'public' : data.chat;
      chats[chatId] = (data.messages||[]).map(m => ({ id:m.id, user:m.user||m.from, profilePic:m.profilePic, message:m.message, timestamp:m.timestamp }));
      // mark seen ids
      for (const m of chats[chatId]) if (m.id) seenMessageIds.add(m.id);
      if (chatId !== 'public' && !openedChats.includes(chatId)){ openedChats.push(chatId); localStorage.setItem('openedChats', JSON.stringify(openedChats)); ensureChatInList(chatId); }
      if (activeChat === chatId) renderChat();
    }

    else if (data.type === 'online'){
      // dedup: mappa per nome
      onlineList.innerHTML = '';
      const map = new Map();
      (data.users||[]).forEach(u => { if (u.name && u.name !== userData.name && !map.has(u.name)) map.set(u.name, u.profilePic||''); });
      for (const [name, pic] of map.entries()){
        const div = document.createElement('div'); div.className='user';
        div.innerHTML = `<img src="${pic}"><span>${name}</span>`;
        div.addEventListener('click', ()=> openPrivateChat(name));
        onlineList.appendChild(div);
      }
    }

    else if (data.type === 'private'){
      // message contains id, from, to, profilePic, message, timestamp
      if (!data.from || !data.to) return;
      const other = (data.from === userData.name) ? data.to : data.from;
      if (!other) return;
      // dedup by id
      if (data.id && seenMessageIds.has(data.id)) return;
      if (data.id) seenMessageIds.add(data.id);

      chats[other] = chats[other] || [];
      // append message; server sends to sender as confirmation and to receiver
      chats[other].push({ id:data.id, user:data.from, profilePic:data.profilePic, message:data.message, timestamp:data.timestamp });
      ensureChatInList(other);
      if (activeChat === other) renderChat();
    }

    else if (data.type === 'profileUpdated'){
      // aggiorna localmente le immagini nella UI (se compaiono nelle liste o chat già caricate)
      // aggiorna chats e localStorage se è il nostro profilo
      if (data.name === userData.name){
        userData.profilePic = data.profilePic||'';
        localStorage.setItem('userData', JSON.stringify(userData));
        profilePicEl.src = userData.profilePic || 'https://via.placeholder.com/64?text=Foto';
      }
      // update nelle chat memorizzate: aggiorna i profilePic dove il nome corrisponde
      for (const key of Object.keys(chats)){
        chats[key] = chats[key].map(m => (m.user === data.name) ? {...m, profilePic: data.profilePic||''} : m );
      }
      if (activeChat) renderChat();
    }
  });
}

/* upload immagine profilo: converte in base64, salva local e invia updateProfilePic */
profilePicEl.addEventListener('click', ()=> picInput.click());
picInput.addEventListener('change', (e)=>{
  const f = e.target.files[0]; if (!f) return;
  if (!f.type.startsWith('image/')) { alert('Seleziona un\'immagine'); return; }
  if (f.size > 2*1024*1024) { if(!confirm('Immagine >2MB. Procedere comunque?')) return; }
  const r = new FileReader();
  r.onload = ()=> {
    const dataUrl = r.result;
    userData.profilePic = dataUrl;
    localStorage.setItem('userData', JSON.stringify(userData));
    profilePicEl.src = dataUrl;
    // invia update
    queueOrSend({ type:'updateProfilePic', profilePic: dataUrl });
  };
  r.readAsDataURL(f);
});

/* GESTIONE REGISTRAZIONE IN-APP (se userData mancante) */
function showRegisterPromptIfNeeded(){
  if (userData && userData.name) return;
  // semplice registrazione in-page: chiediamo nome e foto
  const wrapper = document.createElement('div');
  wrapper.style.position='fixed'; wrapper.style.left='0'; wrapper.style.top='0'; wrapper.style.right='0'; wrapper.style.bottom='0';
  wrapper.style.background='rgba(0,0,0,0.35)'; wrapper.style.display='flex'; wrapper.style.alignItems='center'; wrapper.style.justifyContent='center'; wrapper.style.zIndex=9999;
  const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='18px'; box.style.borderRadius='8px'; box.style.width='360px'; box.style.textAlign='center';
  box.innerHTML = `<h3>Registrazione</h3>
    <input id="reg-name" placeholder="Nome e Cognome" style="width:100%;padding:8px;margin:8px 0"><br>
    <input id="reg-photo" type="file" accept="image/*" style="width:100%;margin-bottom:8px"><br>
    <button id="reg-btn" style="padding:8px 12px;background:#007bff;color:#fff;border:none;border-radius:6px;cursor:pointer">Entra</button>`;
  wrapper.appendChild(box); document.body.appendChild(wrapper);
  document.getElementById('reg-btn').addEventListener('click', ()=>{
    const name = (document.getElementById('reg-name').value||'').trim();
    const file = document.getElementById('reg-photo').files[0];
    if (!/^[A-Za-zÀ-ÿ\s]+$/.test(name) || name.split(/\s+/).length<2){ alert('Inserisci nome e cognome validi'); return; }
    if (!file){ alert('Carica una foto'); return; }
    const fr = new FileReader();
    fr.onload = ()=> {
      userData = { name: name.replace(/\s+/g,' '), profilePic: fr.result };
      localStorage.setItem('userData', JSON.stringify(userData));
      usernameEl.textContent = userData.name;
      profilePicEl.src = userData.profilePic;
      document.body.removeChild(wrapper);
      startSocket();
    };
    fr.readAsDataURL(file);
  });
}

/* inizializzazione UI */
if (!userData) showRegisterPromptIfNeeded();
else {
  usernameEl.textContent = userData.name;
  profilePicEl.src = userData.profilePic || 'https://via.placeholder.com/64?text=Foto';
  // ripristina opened chats in sidebar
  for (const n of openedChats || []) ensureChatInList(n);
  ensureChatInList('public');
  setActiveChat('public');
  startSocket();
}

/* bindings */
sendBtn.addEventListener('click', sendMessage);
msgInput.addEventListener('keydown', e=> { if (e.key === 'Enter') sendMessage(); });

/* mobile sidebar toggle */
if (window.innerWidth <= 768){
  const toggle = document.getElementById('toggle-sidebar');
  if (toggle){
    toggle.style.display='inline-block';
    toggle.addEventListener('click', ()=> document.getElementById('sidebar').classList.toggle('show'));
  }
}
</script>
</body>
</html>
